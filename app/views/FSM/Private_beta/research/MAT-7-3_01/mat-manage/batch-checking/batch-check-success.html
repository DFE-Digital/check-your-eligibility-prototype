{% extends "layouts/FSM/research/LA/layout-dfe-lanav.html" %}
{% set pageName="All checks completed" %}

{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-one-third">
        <span class="govuk-caption-l">MAT-autumnterm25.csv</span>
        <h1 class="govuk-heading-l">16 Batch check results</h1>
      </div>
      <div class="govuk-grid-column-two-thirds" style="display: flex; justify-content: flex-end; align-items: center;">
        <button type="submit" id="exportCsvBtn" class="govuk-button govuk-button--secondary govuk-!-margin-right-15"
          data-module="govuk-button">
          Export all results as CSV
        </button>
      </div>
    </div>

    <!-- <div class="govuk-grid-row">
      <div class="govuk-grid-column-one-third">
        <h1 class="govuk-heading-l">Batch check results</h1>
      </div>
      <div class="govuk-grid-column-two-thirds" style="display: flex; justify-content: flex-end; align-items: center;">
        <button type="submit" class="govuk-button govuk-button--secondary govuk-!-margin-right-15"
          data-module="govuk-button">
          Export all results
        </button>
      </div>
    </div>-->
    </div>


  <div class="govuk-grid-column-full">
    <nav class="moj-sub-navigation" aria-label="Sub navigation">
      <ul class="moj-sub-navigation__list">
        <li class="moj-sub-navigation__item">
          <a class="moj-sub-navigation__link" aria-current="true" data-section="eligible-section" href="#" role="button"><strong>Eligible</strong></a>

          <!-- <a class="moj-sub-navigation__link" aria-current="true" data-section="eligible-section"
            href="#eligible"><strong>Eligible</strong></a> -->
        </li>
        <li class="moj-sub-navigation__item">
          <a class="moj-sub-navigation__link" data-section="not-eligible-section" href="#" role="button"><strong>Not eligible</strong></a>

          <!-- <a class="moj-sub-navigation__link" data-section="not-eligible-section" href="#not-eligible"><strong>Not
              eligible</strong></a> -->
        </li>
        <li class="moj-sub-navigation__item">
          <a class="moj-sub-navigation__link" data-section="not-checked-section" href="#" role="button"><strong>Could not check</strong></a>
<!--
          <a class="moj-sub-navigation__link" data-section="not-checked-section" href="#not-checked"><strong>Could not
              check</strong></a> -->
        </li>
      </ul>
    </nav>


 <div id="eligible-section" class="govuk-table-section govuk-!-padding-left-0">

  <!-- Remove inner grid column so it aligns with the table -->
  <h2 class="govuk-heading-m govuk-!-margin-bottom-2 govuk-!-padding-left-0">7 eligible results</h2>

  <p class="govuk-body govuk-!-margin-bottom-4 govuk-!-padding-left-0">
    These children are eligible for free school meals. Create the application with the supplied information or notify the parent they can apply.
  </p>

  {{ govukButton({
    text: "Create applications",
    href: '../records/batch-records/eligible/batch-confirm-eligible'
  }) }}

  <table class="govuk-table govuk-!-margin-top-5" data-module="moj-multi-select" data-multi-select-checkbox="#select-all"
    data-multi-select-idprefix=" -" data-module="moj-sortable-table">
    <thead class="govuk-table__head">
      <tr class="govuk-table__row">
        <th class="govuk-table__header" scope="col" id="select-all"></th>
        <th scope="col" class="govuk-table__header">Parent name</th>
        <th scope="col" class="govuk-table__header">National <br>Insurance number</th>
        <th scope="col" class="govuk-table__header">Child name</th>
        <th scope="col" class="govuk-table__header govuk-table__header--date">Child date <br>of birth</th>
        <th scope="col" class="govuk-table__header govuk-table__header--date">Academy</th>
        <th scope="col" class="govuk-table__header">Email</th>
        <th scope="col" class="govuk-table__header"> </th>
      </tr>
    </thead>
    <tbody class="govuk-table__body">
    {% include "_includes/mat/batch-check-eligible-mat.html" %}
        </tbody>
      </table>
    </div>
<div id="not-eligible-section" class="govuk-table-section govuk-!-padding-left-0">

  <h2 class="govuk-heading-m govuk-!-margin-bottom-2 govuk-!-padding-left-0">5 not eligible results</h2>

  <p class="govuk-body govuk-!-margin-bottom-4 govuk-!-padding-left-0">
    These children may not be eligible. The parent or guardian can still apply but must provide supporting evidence.
  </p>

  <div class="govuk-button-group govuk-!-padding-left-0 govuk-!-margin-bottom-4">
    <!-- Uncomment this button when needed -->
<!--
    {{ govukButton({
      text: "Notify parent",
      classes: "govuk-button--secondary",
      href: ' '
    }) }} -->

  </div>

  <table class="govuk-table govuk-!-margin-top-5" data-module="moj-multi-select" data-multi-select-checkbox="#select-all"
    data-multi-select-idprefix=" -" data-module="moj-sortable-table">
    <thead class="govuk-table__head">
      <tr class="govuk-table__row">
        <th scope="col" class="govuk-table__header">Parent name</th>
        <th scope="col" class="govuk-table__header">National Insurance number</th>
        <th scope="col" class="govuk-table__header">Child name</th>
        <th scope="col" class="govuk-table__header govuk-table__header--date">Child date of birth</th>
        <th scope="col" class="govuk-table__header govuk-table__header--date">Academy</th>
        <th scope="col" class="govuk-table__header">Email</th>
        <th scope="col" class="govuk-table__header"> </th>
      </tr>
    </thead>
    <tbody class="govuk-table__body">

          {% include "_includes/mat/batch-check-not-eligible-mat.html" %}

        </tbody>
      </table>
    </div>

<div id="not-checked-section" class="govuk-table-section govuk-!-padding-left-0">

  <h2 class="govuk-heading-m govuk-!-margin-bottom-2 govuk-!-padding-left-0">4 files that could not be checked</h2>

  <p class="govuk-body govuk-!-margin-bottom-4 govuk-!-padding-left-0">
    These records could not be checked for the reason stated. You can remove the records, fix the record in the batch check file or notify the parent or guardian.
  </p>

  <div class="govuk-button-group govuk-!-padding-left-0 govuk-!-margin-bottom-4">
    <!-- Optional buttons can go here -->
  </div>

  <table class="govuk-table govuk-!-margin-top-5"
    data-module="moj-multi-select"
    data-multi-select-checkbox="#select-all"
    data-multi-select-idprefix=" -"
    data-module="moj-sortable-table">
    <thead class="govuk-table__head">
      <tr class="govuk-table__row">
        <th scope="col" class="govuk-table__header">Parent name</th>
        <th scope="col" class="govuk-table__header">National Insurance number</th>
        <th scope="col" class="govuk-table__header">Child name</th>
        <th scope="col" class="govuk-table__header govuk-table__header--date">Child date of birth</th>
        <th scope="col" class="govuk-table__header govuk-table__header--date">Academy</th>
        <th scope="col" class="govuk-table__header">Email</th>
        <th scope="col" class="govuk-table__header">Reason</th>
      </tr>
    </thead>
    <tbody class="govuk-table__body">
          {% include "_includes/mat/batch-check-not-check-mat.html" %}

        </tbody>
      </table>
        </tbody>
      </table>
    </div>
  </div>


  </tbody>
  </table>
</div>
<!-- <nav class="govuk-pagination" aria-label="Pagination" style="display: flex; justify-content: center;">
  <div class="govuk-pagination__prev">
    <a class="govuk-link govuk-pagination__link" href="#" rel="prev">
      <svg class="govuk-pagination__icon govuk-pagination__icon--prev" xmlns="http://www.w3.org/2000/svg" height="13" width="15" aria-hidden="true" focusable="false" viewBox="0 0 15 13">
        <path d="m6.5938-0.0078125-6.7266 6.7266 6.7441 6.4062 1.377-1.449-4.1856-3.9768h12.896v-2h-12.984l4.2931-4.293-1.414-1.414z"></path>
      </svg>
      <span class="govuk-pagination__link-title">
        Previous<span class="govuk-visually-hidden"> page</span>
      </span>
    </a>
  </div>
  <ul class="govuk-pagination__list">
    <li class="govuk-pagination__item">
      <a class="govuk-link govuk-pagination__link" href="#" aria-label="Page 1">
        1
      </a>
    </li>
    <li class="govuk-pagination__item govuk-pagination__item--ellipses">
      &ctdot;
    </li>
    <li class="govuk-pagination__item govuk-pagination__item--current">
      <a class="govuk-link govuk-pagination__link" href="#" aria-label="Page 6">
        6
      </a>
    </li>
    <li class="govuk-pagination__item">
      <a class="govuk-link govuk-pagination__link" href="#" aria-label="Page 7" aria-current="page">
        7
      </a>
    </li>
    <li class="govuk-pagination__item">
      <a class="govuk-link govuk-pagination__link" href="#" aria-label="Page 8">
        8
      </a>
    </li>
    <li class="govuk-pagination__item govuk-pagination__item--ellipses">
      &ctdot;
    </li>
    <li class="govuk-pagination__item">
      <a class="govuk-link govuk-pagination__link" href="#" aria-label="Page 42">
        42
      </a>
    </li>
  </ul>
  <div class="govuk-pagination__next">
    <a class="govuk-link govuk-pagination__link" href="#" rel="next">
      <span class="govuk-pagination__link-title">
        Next<span class="govuk-visually-hidden"> page</span>
      </span>
      <svg class="govuk-pagination__icon govuk-pagination__icon--next" xmlns="http://www.w3.org/2000/svg" height="13" width="15" aria-hidden="true" focusable="false" viewBox="0 0 15 13">
        <path d="m8.107-0.0078125-1.4136 1.414 4.2926 4.293h-12.986v2h12.896l-4.1855 3.9766 1.377 1.4492 6.7441-6.4062-6.7246-6.7266z"></path>
      </svg>
    </a>
  </div>
</nav> -->

  <!-- <nav class="moj-pagination" aria-label="Pagination navigation">

    <ul class="moj-pagination__list">
      <li class="moj-pagination__item  moj-pagination__item--prev">
        <a class="moj-pagination__link" href="">Previous<span class="govuk-visually-hidden"> page</span></a>
      </li>

      <li class="moj-pagination__item"><a class="moj-pagination__link" href="/page=1" aria-label="Page 1 of 5">1</a>
      </li>

      <li class="moj-pagination__item moj-pagination__item--active" aria-label="Page 2 of 5" aria-current="page">2
      </li>

      <li class="moj-pagination__item"><a class="moj-pagination__link" href="/page=3" aria-label="Page 3 of 5">3</a>
      </li>

      <li class="moj-pagination__item moj-pagination__item--dots">â€¦</li>

      <li class="moj-pagination__item"><a class="moj-pagination__link" href="/page=5" aria-label="Page 5 of 5">5</a>
      </li>

      <li class="moj-pagination__item  moj-pagination__item--next">
        <a class="moj-pagination__link" href="">Next<span class="govuk-visually-hidden"> page</span></a>
      </li>
    </ul>
    <p class="moj-pagination__results">Showing <b>5</b> to <b>10</b> of <b>30</b> results</p>
  </nav> -->

</div>
</div>

{% endblock %}


{% block scripts %}
{{ super() }}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const navLinks = document.querySelectorAll('.moj-sub-navigation__link');
    const sections = document.querySelectorAll('.govuk-table-section');

    function showSection(targetId) {
      sections.forEach(section => {
        section.style.display = section.id === targetId ? 'block' : 'none';
      });
    }

    function updateNavigation(event) {
      event.preventDefault();
      const targetId = this.getAttribute('data-section');

      // Update tab state
      navLinks.forEach(nav => nav.removeAttribute('aria-current'));
      this.setAttribute('aria-current', 'true');

      // Show corresponding section
      showSection(targetId);

      // ðŸš« Don't update the hash to prevent scroll jump
      // window.location.hash = targetId;
    }

    navLinks.forEach(link => link.addEventListener('click', updateNavigation));

    // On load: show section based on hash (if valid), otherwise default to first tab
    const currentHash = window.location.hash.replace('#', '');
    const validSection = [...sections].some(section => section.id === currentHash);
    const defaultSection = navLinks[0].getAttribute('data-section');
    showSection(validSection ? currentHash : defaultSection);
  });
</script>

<script>
document.getElementById("exportCsvBtn").addEventListener("click", function () {
  const sections = document.querySelectorAll(".batch-check-section");

  let allRows = [];

  sections.forEach(section => {
    const rows = section.querySelectorAll("tbody tr");
    rows.forEach(row => {
      const cells = Array.from(row.querySelectorAll("td"));
      const rowData = cells.map(cell => cell.innerText.trim().replace(/"/g, '""'));

      // Add status and (if eligible) end date
      const status = row.dataset.status || "";
      const endDate = row.dataset.endDate || "";

      rowData.push(status);
      rowData.push(endDate);

      allRows.push(rowData);
    });
  });

  // Create header
  const headers = ["Parent name", "NI number", "Child name", "Child DOB", "School", "Email", "Status", "End date"];
  allRows.unshift(headers);

  // Convert to CSV
  const csvContent = allRows.map(row => row.map(cell => `"${cell}"`).join(",")).join("\n");
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  // Download
  const link = document.createElement("a");
  link.setAttribute("href", url);
  link.setAttribute("download", "batch-check-results.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
});
</script>


{% endblock %}